---
title: "Project 3 - Data Scientist Skills"
subtitle: "DATA607 - Acquisition of Data and Management - Instructor: Andrew Catlin"
Subtitle: "Team 7: Gabriel Campos, Maliat Islam, Joe Connolly, Gabriella Martinez"
date: "Date: 3/23/2021"
output:
  html_document: default
  pdf_document: default
---
```{r message=FALSE}
# Load needed libraries
library(devtools)
library(tidyverse)
library(RCurl)
library(plyr)
library(knitr)
library(RMySQL)
```

Function call to MySQL db to connect and use the return command in a function.

```{r MySQL Connect Function}
conn.MySQL <- function(db_parms)
{
  db_conn <- dbConnect(MySQL(), user=db_user, password=db_password, dbname=db_name, host=db_host)
  return(db_conn)
}
```

Source the credentials parameter file from your local directory.  Do not store in github repository since R has no encryption capability.

```{r Read the user MySQl Parameter credentials file}
filename <- "/Users/Audiorunner13/CUNY MSDS Course Work/DATA607 Spring 2021/Week7/Project3/MySQL_parms.csv"
db_parms <- read.csv(filename)
```

Set the login application credential to pass to the db log in function

```{r Set  up DB parms}
db_user = db_parms$db_user
db_password = db_parms$db_password
db_name = db_parms$db_name
db_host = db_parms$db_host
db_result_set = ""

db_parms <- c(db_user, db_password, db_name, db_host, db_result_set)
```

Call the conn.MySql connect function to access the movies database

```{r Connect to the MySQL db}
db_conn <- conn.MySQL(db_parms)
```

Use the dbListTables() function to list the tables in the database

```{r List the tables in the movies db}
dbListTables(db_conn)
```

Use the dbListFields() function to list the fields in a database table

```{r List the fields in the movie dimension database table}
dbListFields(db_conn, "location_dim")
```

Source the movie dimension file from the movies github repository to load to the movie dimension

```{r Source the location dimension file to load}
filename <- "/Users/Audiorunner13/CUNY MSDS Course Work/DATA607 Spring 2021/Week7/Project3/Data/job_location.csv"
location_dim_df <- read.csv(filename)
head(location_dim_df,10)
```

Drop dimension and fact tables if they exist. Dropping and reloading is only recommended when table size and contents is small.  Write the database tables from their respective data frames.

```{r Append new records to location dimension}
dbSendQuery(db_conn, "SET GLOBAL local_infile = true;")
dbWriteTable(db_conn, name = "location_dim", value = location_dim_df, append = TRUE,row.names = FALSE)
```

Source the customer dimension file from the movies github repository to load to the customer dimension

```{r Source the job Openings file to load}
filename <- "/Users/Audiorunner13/CUNY MSDS Course Work/DATA607 Spring 2021/Week7/Project3/Data/job_openings.csv"
job_opening_df <- read.csv(filename)
head(job_opening_df,10)
```

```{r append new records to the job opening table}
dbSendQuery(db_conn, "SET GLOBAL local_infile = true;")
dbWriteTable(db_conn, name = "job_opening_tbl", value = job_opening_df, append = TRUE, row.names = FALSE)
```

Source the sql file in the movies github repositpry.  The sql will extract all survey answers and order by them first name, last name, and movie title and will replace nulls in the AFI 100 Rank field if a movie is not ranked.

```{r source sql file and substitute each new line "\n" with a space}
filename <- "/Users/Audiorunner13/CUNY MSDS Course Work/DATA607 Spring 2021/Week7/Project3/Sql/jobs_location.sql"
db_sql <- readChar(filename, file.info(filename)$size)
db_sql <- gsub("\n", " ",db_sql)
db_sql
```

Execute the sql query joining the fact table to the dimension tables and return all records in the result set.  Specify the number of records to return by adjusting the "n = " argument.

```{r execute sql query and return result set}
db_data = dbSendQuery(db_conn, db_sql)
result_set = fetch(db_data, n = -1)
head(result_set,10)
```

The result_set containing the extracted data is a data.frame.

```{r display the class of the result set}
class(result_set)
```